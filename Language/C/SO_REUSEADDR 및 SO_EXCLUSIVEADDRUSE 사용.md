# SO_REUSEADDR 및 SO_EXCLUSIVEADDRUSE 사용

출처:  https://docs.microsoft.com/en-us/windows/win32/winsock/using-so-reuseaddr-and-so-exclusiveaddruse

보안 높은 수준의 네트워크 인프라를 개발하는 것은 대부분의 네트워크 애플리케이션 개발자에게 우선 순위입니다. 그러나 완전히 안전한 솔루션을 고려할 때 매우 중요 함에도 불구하고 소켓 보안은 종종 간과됩니다. 특히 소켓 보안은 이전에 다른 응용 프로그램 프로세스에 의해 바인드 된 동일한 포트에 바인드 된 프로세스를 다룹니다. 과거에는 네트워크 응용 프로그램이 다른 응용 프로그램의 포트를 '도용'할 수 있었으며, 이는 '서비스 거부'공격이나 데이터 도용으로 쉽게 이어질 수있었습니다.

일반적으로 소켓 보안은 서버 측 프로세스에 적용됩니다. 보다 구체적으로 소켓 보안은 연결을 허용하고 IP 데이터 그램 트래픽을 수신하는 모든 네트워크 응용 프로그램에 적용됩니다. 이러한 응용 프로그램은 일반적으로 잘 알려진 포트에 바인딩되며 악성 네트워크 코드의 일반적인 대상입니다.

클라이언트 애플리케이션은 취약성이 적기 때문이 아니라 대부분의 클라이언트가 정적 '서비스'포트가 아닌 '임시'로컬 포트에 바인드되기 때문에 이러한 공격의 대상이 될 가능성이 적습니다. 클라이언트 네트워크 애플리케이션은 불가피한 구조적 이유가없는 한 항상 임시 포트에 바인딩해야합니다 (바인드 함수를 호출 할 때 이름 매개 변수가 가리키는 SOCKADDR 구조에서 포트 0을 지정하여). 임시 로컬 포트는 포트 49151보다 큰 포트로 구성됩니다. 전용 서비스를위한 대부분의 서버 응용 프로그램은 포트 49151보다 작거나 같은 잘 알려진 예약 포트에 바인딩됩니다. 따라서 대부분의 응용 프로그램의 경우 일반적으로 바인딩 요청에 대한 충돌이 발생하지 않습니다. 클라이언트와 서버 응용 프로그램 사이.

이 섹션에서는 다양한 Microsoft Windows 플랫폼의 기본 보안 수준과 특정 소켓 옵션 SO_REUSEADDR 및 SO_EXCLUSIVEADDRUSE가 네트워크 응용 프로그램 보안에 미치는 영향과 영향에 대해 설명합니다. 향상된 소켓 보안이라는 추가 기능은 Windows Server 2003 이상에서 사용할 수 있습니다. 이러한 소켓 옵션 및 강화 된 소켓 보안의 가용성은 아래 표에 표시된 것처럼 Microsoft 운영 체제 버전에 따라 다릅니다.

| Platform            | SO_REUSEADDR | SO_EXCLUSIVEADDRUSE                   | Enhanced socket security |
| :------------------ | :----------- | :------------------------------------ | :----------------------- |
| Windows 95          | Available    | Not Available                         | Not Available            |
| Windows 98          | Available    | Not Available                         | Not Available            |
| Windows Me          | Available    | Not Available                         | Not Available            |
| Windows NT 4.0      | Available    | Available in Service Pack 4 and later | Not Available            |
| Windows 2000        | Available    | Available                             | Not Available            |
| Windows XP          | Available    | Available                             | Not Available            |
| Windows Server 2003 | Available    | Available                             | Available                |
| Windows Vista       | Available    | Available                             | Available                |
| Windows Server 2008 | Available    | Available                             | Available                |
| Windows 7and newer  | Available    | Available                             | Available                |



## Using SO_REUSEADDR

SO_REUSEADDR 소켓 옵션을 사용하면 소켓이 다른 소켓에서 사용중인 포트에 강제로 바인딩 할 수 있습니다. 두 번째 소켓은 원래 소켓과 동일한 포트에서 bind를 호출하기 전에 optname 매개 변수를 SO_REUSEADDR로 설정하고 optval 매개 변수를 부울 값 TRUE로 설정하여 setsockopt를 호출합니다. 두 번째 소켓이 성공적으로 바인드되면 해당 포트에 바인드 된 모든 소켓의 동작이 결정되지 않습니다. 예를 들어, 동일한 포트의 모든 소켓이 TCP 서비스를 제공하는 경우 포트를 통해 들어오는 모든 TCP 연결 요청이 올바른 소켓에서 처리된다는 것을 보장을 할 수 없습니다. 동작은 비 결정적입니다. 악성 프로그램은 SO_REUSEADDR을 사용하여 표준 네트워크 프로토콜 서비스에 이미 사용중인 소켓을 강제로 바인딩하여 해당 서비스에 대한 액세스를 거부 할 수 있습니다. 이 옵션을 사용하는 데 특별한 권한이 필요하지 않습니다.

클라이언트 응용 프로그램이 서버 응용 프로그램이 동일한 포트에 바인딩되기 전에 포트에 바인딩되면 문제가 발생할 수 있습니다. 서버 응용 프로그램이 SO_REUSEADDR 소켓 옵션을 사용하여 동일한 포트에 강제로 바인딩하면 해당 포트에 바인딩 된 모든 소켓에 대한 동작이 결정되지 않습니다.

이 비 결정적 동작의 예외는 멀티 캐스트 소켓입니다. 두 소켓이 동일한 인터페이스 및 포트에 바인딩되어 있고 동일한 멀티 캐스트 그룹의 구성원 인 경우 데이터는 임의로 선택한 소켓이 아닌 두 소켓에 모두 전달됩니다.



## Using SO_EXCLUSIVEADDRUSE

SO_EXCLUSIVEADDRUSE 소켓 옵션이 도입되기 전에는 네트워크 응용 프로그램 개발자가 네트워크 응용 프로그램이 자체 소켓이 바인딩 된 포트에 바인딩되는 것을 막기 위해 네트워크 응용 프로그램 개발자가 할 수있는 일이 거의 없었습니다. 이 보안 문제를 해결하기 위해 Windows 소켓은 SO_EXCLUSIVEADDRUSE 소켓 옵션을 도입했습니다.이 옵션은 Windows NT 4.0 서비스 팩 4 (SP4) 이상에서 사용할 수 있습니다.

SO_EXCLUSIVEADDRUSE 소켓 옵션은 Windows XP 및 이전 버전에서 관리자 보안 그룹의 구성원 만 사용할 수 있습니다. 이 요구 사항이 Windows Server 2003 이상에서 변경된 이유는 문서 뒷부분에서 설명합니다.

SO_EXCLUSIVEADDRUSE 옵션은 소켓이 바인딩되기 전에 optname 매개 변수가 SO_EXCLUSIVEADDRUSE로 설정되고 optval 매개 변수가 부울 값 TRUE로 설정된 setsockopt 함수를 호출하여 설정됩니다. 옵션이 설정된 후 후속 바인드 호출의 동작은 각 바인드 호출에 지정된 네트워크 주소에 따라 다릅니다.

아래 표에서는 두 번째 소켓이 특정 소켓 옵션을 사용하여 이전에 첫 번째 소켓에 의해 바인딩 된 주소에 바인딩을 시도 할 때 Windows XP 및 이전 버전에서 발생하는 동작을 설명합니다.

```
Note
아래 표에서 '와일드 카드'는 주어진 프로토콜의 와일드 카드 주소를 나타냅니다 (예 : IPv4의 경우 '0.0.0.0', IPv6의 경우 '::'). '특정'은 인터페이스에 할당 된 특정 IP 주소를 나타냅니다. 테이블 셀은 바인드가 성공했는지 ( '성공') 또는 오류가 리턴되었는지 (WSAEADDRINUSE 오류의 경우 'INUSE', WSAEACCES 오류의 경우 'ACCESS')를 나타냅니다.
```

`표 생략`

두 소켓이 동일한 포트 번호에 바인딩되어 있지만 명시 적 인터페이스가 다른 경우 충돌이 없습니다. 예를 들어 컴퓨터에 두 개의 IP 인터페이스 (10.0.0.1 및 10.99.99.99)가있는 경우 바인딩에 대한 첫 번째 호출이 10.0.0.1에서 포트가 5150으로 설정되고 SO_EXCLUSIVEADDRUSE가 지정된 경우 바인딩 할 두 번째 호출이 포트도 5150으로 설정되고 지정된 옵션이없는 경우 10.99.99.99가 성공합니다. 그러나 첫 번째 소켓이 와일드 카드 주소 및 포트 5150에 바인딩 된 경우 SO_EXCLUSIVEADDRUSE가 설정된 포트 5150에 대한 후속 바인딩 호출은 바인딩 작업에서 반환 된 WSAEADDRINUSE 또는 WSAEACCES와 함께 실패합니다.

바인드에 대한 첫 번째 호출이 SO_REUSEADDR을 설정하거나 소켓 옵션을 전혀 설정하지 않는 경우 두 번째 바인드 호출은 포트를 '도용'하고 애플리케이션은 두 소켓 중 어떤 소켓이 '공유'로 전송 된 특정 패킷을 수신했는지 확인할 수 없습니다. ' 포트.

bind 함수를 호출하는 일반적인 응용 프로그램은 bind 함수를 호출하기 전에 소켓에서 SO_EXCLUSIVEADDRUSE 소켓 옵션이 호출되지 않는 한 배타적 사용을 위해 바인딩 된 소켓을 할당하지 않습니다. 클라이언트 애플리케이션이 서버 애플리케이션이 동일한 포트에 바인드하기 전에 임시 포트 또는 특정 포트에 바인드하면 문제가 발생할 수 있습니다. 서버 응용 프로그램은 bind 함수를 호출하기 전에 소켓의 SO_REUSEADDR 소켓 옵션을 사용하여 동일한 포트에 강제로 바인딩 할 수 있지만 해당 포트에 바인딩 된 모든 소켓의 동작은 결정되지 않습니다. 서버 애플리케이션이 포트 전용으로 SO_EXCLUSIVEADDRUSE 소켓 옵션을 사용하려고하면 요청이 실패합니다.

반대로, SO_EXCLUSIVEADDRUSE가 설정된 소켓은 소켓 종료 직후 반드시 재사용 할 수 없습니다. 예를 들어, SO_EXCLUSIVEADDRUSE가 설정된 리스닝 소켓이 연결을 수락 한 다음 닫히는 경우 다른 소켓 (SO_EXCLUSIVEADDRUSE도 포함)은 원래 연결이 비활성화 될 때까지 첫 번째 소켓과 동일한 포트에 바인딩 할 수 없습니다.

소켓이 닫혀 있어도 기본 전송 프로토콜이 연결을 종료하지 않을 수 있기 때문에이 문제는 복잡해질 수 있습니다. 애플리케이션이 소켓을 닫은 후에도 시스템은 버퍼링 된 데이터를 전송하고, 단계적 연결 해제 메시지를 피어에 전송하고, 피어로부터 해당하는 단계적 연결 해제 메시지를 기다려야합니다. 기본 전송 프로토콜이 연결을 해제하지 않을 수도 있습니다. 예를 들어 원래 연결에 참여하는 피어는 크기가 0 인 창이나 다른 형태의 '공격'구성을 광고 할 수 있습니다. 이 경우 클라이언트 연결은 닫으라는 요청에도 불구하고 승인되지 않은 데이터가 버퍼에 남아 있기 때문에 활성 상태로 유지됩니다.

이러한 상황을 방지하기 위해 네트워크 응용 프로그램은 SD_SEND 플래그를 설정하여 shutdown을 호출하여 정상적인 종료를 보장 한 다음 연결을 통해 0 바이트가 반환 될 때까지 recv 루프에서 대기해야합니다. 이는 모든 데이터가 피어에 의해 수신되도록 보장하고 마찬가지로 전송 된 모든 데이터를 수신했음을 피어와 확인하고 앞서 언급 한 포트 재사용 문제를 방지합니다.

SO_LINGER 소켓 옵션은 포트가 '활성'대기 상태로 전환되는 것을 방지하기 위해 소켓에 설정 될 수 있습니다. 그러나 이것은 연결 재설정과 같은 원하는 효과로 이어질 수 있으므로 권장하지 않습니다. 예를 들어 피어가 데이터를 수신했지만 승인되지 않은 상태로 남아 있고 로컬 컴퓨터가 SO_LINGER가 설정된 소켓을 닫으면 두 컴퓨터 간의 연결이 재설정되고 승인되지 않은 데이터는 피어가 버립니다. 시간 초과 값이 작을수록 연결이 갑자기 중단되는 경우가 많고, 시간 초과 값이 클수록 시스템이 서비스 거부 공격에 취약 해 지므로 (많은 연결을 설정하고 잠재적으로 응용 프로그램 스레드를 지연 / 차단하여) 적절한 시간을 선택하는 것은 어렵습니다. 0이 아닌 지연 시간 제한 값이있는 소켓을 닫으면 closesocket 호출이 차단 될 수도 있습니다.

## Enhanced Socket Security

Windows Server 2003의 릴리스와 함께 강화 된 소켓 보안이 추가되었습니다. 이전 Microsoft 서버 운영 체제 릴리스에서는 기본 소켓 보안을 통해 프로세스가 의심하지 않는 애플리케이션에서 포트를 쉽게 탈취 할 수있었습니다. Windows Server 2003에서 소켓은 기본적으로 공유 가능한 상태가 아닙니다. 따라서 응용 프로그램에서 다른 프로세스가 소켓이 이미 바인딩 된 포트를 재사용 할 수 있도록하려면 특별히 활성화해야합니다. 이 경우 포트에서 bind를 호출하는 첫 번째 소켓은 소켓에 SO_REUSEADDR을 설정해야합니다. 이 경우 유일한 예외는 바인딩을 원래 호출 한 동일한 사용자 계정에서 두 번째 바인드 호출을 수행 할 때 발생합니다. 이 예외는 이전 버전과의 호환성을 제공하기 위해서만 존재합니다.

아래 표는 두 번째 소켓이 특정 소켓 옵션을 사용하여 이전에 첫 번째 소켓에 의해 바인딩 된 주소에 바인딩을 시도 할 때 Windows Server 2003 이상 운영 체제에서 발생하는 동작을 설명합니다.

```
Note
아래 표에서 '와일드 카드'는 주어진 프로토콜의 와일드 카드 주소를 나타냅니다 (예 : IPv4의 경우 '0.0.0.0', IPv6의 경우 '::'). '특정'은 인터페이스에 할당 된 특정 IP 주소를 나타냅니다. 테이블 셀은 바인드가 성공했는지 ( '성공') 또는 반환 된 오류 (WSAEADDRINUSE 오류의 경우 'INUSE', WSAEACCES 오류의 경우 'ACCESS')를 나타냅니다.

또한이 특정 테이블에서 두 바인드 호출은 동일한 사용자 계정에서 이루어집니다.
```

`표 생략`

위 표의 몇 가지 항목은 설명 할만한 가치가 있습니다.

예를 들어, 첫 번째 호출자가 특정 주소에 SO_EXCLUSIVEADDRUSE를 설정하고 두 번째 호출자가 동일한 포트에서 와일드 카드 주소로 bind를 호출하려고하면 두 번째 바인드 호출이 성공합니다. 이 특별한 경우 두 번째 호출자는 첫 번째 호출자가 바인딩 된 특정 주소를 제외한 모든 인터페이스에 바인딩됩니다. 이 경우의 반대는 사실이 아닙니다. 첫 번째 호출자가 SO_EXCLUSIVEADDRUSE를 설정하고 와일드 카드 플래그로 bind를 호출하면 두 번째 호출자는 동일한 포트로 bind를 호출 할 수 없습니다.

소켓 바인딩 동작은 다른 사용자 계정에서 소켓 바인딩 호출이 수행 될 때 변경됩니다. 아래 표는 두 번째 소켓이 특정 소켓 옵션 및 다른 사용자 계정을 사용하여 이전에 첫 번째 소켓에 의해 바인딩 된 주소에 바인딩을 시도 할 때 Windows Server 2003 이상 운영 체제에서 발생하는 동작을 지정합니다.

`표 생략`

다른 사용자 계정에서 바인드 호출을 수행 할 때 기본 동작이 다릅니다. 첫 번째 호출자가 소켓에 옵션을 설정하지 않고 와일드 카드 주소에 바인딩하면 두 번째 호출자는 SO_REUSEADDR 옵션을 설정할 수 없으며 동일한 포트에 성공적으로 바인딩 할 수 없습니다. 옵션이 설정되지 않은 기본 동작도 오류를 반환합니다.

Windows Vista 이상에서는 IPv6 및 IPv4 모두에서 작동하는 듀얼 스택 소켓을 만들 수 있습니다. 듀얼 스택 소켓이 와일드 카드 주소에 바인드되면 지정된 포트가 IPv4 및 IPv6 네트워킹 스택 모두에 예약되고 SO_REUSEADDR 및 SO_EXCLUSIVEADDRUSE (설정된 경우)와 관련된 검사가 수행됩니다. 이러한 검사는 두 네트워킹 스택 모두에서 성공해야합니다. 예를 들어 이중 스택 TCP 소켓이 SO_EXCLUSIVEADDRUSE를 설정 한 다음 포트 5000에 바인딩하려고하면 이전에 다른 TCP 소켓을 포트 5000 (와일드 카드 또는 특정)에 바인딩 할 수 없습니다. 이 경우 IPv4 TCP 소켓이 이전에 포트 5000의 루프백 주소에 바인딩 된 경우 이중 스택 소켓에 대한 바인딩 호출이 WSAEACCES와 함께 실패합니다.

## Application Strategies

소켓 계층에서 동작하는 네트워크 애플리케이션을 개발할 때 필요한 소켓 보안 유형을 고려하는 것이 중요합니다. 클라이언트 애플리케이션 (서비스에 데이터를 연결하거나 전송하는 애플리케이션)은 임의의 로컬 (임시) 포트에 바인딩되므로 추가 단계가 거의 필요하지 않습니다. 클라이언트가 올바르게 작동하기 위해 특정 로컬 포트 바인딩이 필요한 경우 소켓 보안을 고려해야합니다.

SO_REUSEADDR 옵션은 데이터가 동일한 포트에 바인딩 된 모든 소켓에 전달되는 멀티 캐스트 소켓을 제외하고 일반 애플리케이션에서 거의 사용되지 않습니다. 그렇지 않으면이 소켓 옵션을 설정하는 모든 애플리케이션은 '소켓 하이재킹'에 매우 취약하기 때문에 종속성을 제거하도록 재 설계해야합니다. SO_REUSEADDR 소켓 옵션을 사용하여 서버 애플리케이션의 포트를 잠재적으로 하이재킹 할 수있는 한 애플리케이션은 안전하지 않은 것으로 간주되어야합니다.

모든 서버 응용 프로그램은 강력한 수준의 소켓 보안을 위해 SO_EXCLUSIVEADDRUSE를 설정해야합니다. 악성 소프트웨어가 포트를 가로채는 것을 방지 할뿐만 아니라 다른 응용 프로그램이 요청 된 포트에 바인딩되었는지 여부도 나타냅니다. 예를 들어, 다른 프로세스가 현재 특정 인터페이스의 동일한 포트에 바인드 된 경우 SO_EXCLUSIVEADDRUSE 소켓 옵션이 설정된 프로세스에 의한 와일드 카드 주소 바인드 호출이 실패합니다.

마지막으로 Windows Server 2003에서 소켓 보안이 개선 되었더라도 애플리케이션은 항상 SO_EXCLUSIVEADDRUSE 소켓 옵션을 설정하여 프로세스가 요청한 모든 특정 인터페이스에 바인딩되도록해야합니다. Windows Server 2003의 소켓 보안은 기존 애플리케이션의 보안 수준을 높여 주지만 애플리케이션 개발자는 모든 보안 측면을 염두에두고 제품을 설계해야합니다.

